<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <!--
    Planejamento Narrativo e Estrutura:
    Esta infografia SPA (Single Page Application) visa simular um gestor de gastos para construção residencial,
    focando na facilidade de registro e visualização de dados.
    A narrativa segue a jornada do usuário:
    1.  Introdução: Contexto sobre a importância da gestão de gastos em obras.
    2.  Entrada de Dados por Categoria: Seções dedicadas para "Mão de Obra", "Ferramentas", "Material da Obra" e "Gastos Indiretos", permitindo o registro detalhado de cada despesa.
    3.  Resumo e Visualização: Uma seção centralizada para exibir o total de gastos por categoria e um gráfico de pizza para a distribuição percentual, além do total geral.
    4.  Visualização Detalhada da Planilha: Uma nova seção para listar os gastos de cada categoria em formato de tabela, permitindo um acompanhamento mais granular.
    5.  Previsão de Pagamentos Mensais: Adição de uma tabela para prever pagamentos futuros de cartões parcelados.
    O objetivo é transformar dados brutos em insights compreensíveis rapidamente.
    -->
    <!--
    Seleção de Visualizações e Justificativa (Confirmando NENHUM uso de SVG ou Mermaid JS):
    - **Total de Gastos por Categoria (Tabela de Resumo):** Objetivo "Organizar" e "Informar". Uma tabela é a forma mais clara para exibir múltiplos pontos de dados com unidades diferentes (valores monetários) e permitir uma comparação fácil. Implementado com HTML/CSS (Tailwind).
    - **Total Geral (Número Grande):** Objetivo "Informar". Um número grande e em destaque é ideal para transmitir um dado único e crucial (o custo total acumulado) de forma imediata. Implementado com HTML/CSS (Tailwind).
    - **Gráfico de Pizza/Donut (Chart.js):** Objetivo "Comparar" e "Informar" a composição. O gráfico de pizza/donut é excelente para mostrar a proporção de cada categoria de gasto em relação ao total, facilitando a digestão visual da distribuição de custos. Implementado com Chart.js (Canvas). Chart.js é escolhido por sua versatilidade em tipos de gráficos comuns e renderização em Canvas.
    - **Entrada de Dados (Formulários):** Objetivo "Organizar". Estruturas de formulários com campos claros e dropdowns para padronização. Implementado com HTML/CSS (Tailwind) e JavaScript para lógica de adição.
    - **Tabelas de Gastos Detalhados por Categoria:** Objetivo "Organizar" e "Informar". Permite visualizar cada item de gasto com seus detalhes (data, descrição, valor, etc.) em um formato tabular que simula uma planilha. Implementado com HTML/CSS (Tailwind) e JavaScript para a renderização dinâmica.
    - **Tabela de Previsão de Pagamentos Mensais:** Objetivo "Informar" e "Organizar". Uma tabela com meses e valores por cartão oferece uma previsão clara e estruturada dos compromissos financeiros futuros, essencial para o planejamento. Implementado com HTML/CSS (Tailwind) e JavaScript para a lógica de cálculo e renderização.
    Nenhuma biblioteca ou tecnologia que gere SVG foi utilizada (como Plotly.js para gráficos avançados, pois o escopo não exigiu). Nenhuma ferramenta de diagrama como Mermaid JS foi utilizada; layouts de seção são feitos com HTML/CSS e Tailwind.
    -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Gastos da Construção - Infografia</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Paleta de Cores "Energetic & Playful" (Adaptado de colour combinations) */
        /* #FF5733 (Red-Orange) - Cor primária para botões/destaques */
        /* #FFC300 (Amber Yellow) - Cor secundária */
        /* #C70039 (Deep Red/Magenta) - Ênfase, avisos */
        /* #900C3F (Darker Red/Purple) - Texto principal, fundos escuros */
        /* #581845 (Very Dark Purple) - Fundos muito escuros */
        :root {
            --color-primary: #FF5733;
            --color-secondary: #FFC300;
            --color-emphasis: #C70039;
            --color-dark-text: #900C3F;
            --color-darker-bg: #581845;
            --color-light-bg: #F3F4F6; /* Gray-100 */
            --color-card-bg: #FFFFFF;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-light-bg);
            color: var(--color-dark-text);
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px; /* Limite a largura máxima do gráfico */
            margin-left: auto;
            margin-right: auto;
            height: 350px; /* Altura base para o gráfico */
            max-height: 400px;
        }

        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        .tab-button {
            transition: background-color 0.3s ease, transform 0.1s ease;
        }
        .tab-button.active {
            background-color: var(--color-primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .tab-button:not(.active):hover {
            background-color: var(--color-secondary);
            color: var(--color-dark-text);
        }
        /* Estilos para o modal de confirmação e alerta */
        .modal {
            display: none; /* Escondido por padrão */
            position: fixed; /* Fixo na tela */
            z-index: 1000; /* Acima de outros elementos */
            left: 0;
            top: 0;
            width: 100%; /* Largura total */
            height: 100%; /* Altura total */
            overflow: auto; /* Habilita scroll se necessário */
            background-color: rgba(0,0,0,0.4); /* Fundo semi-transparente */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            width: 80%;
            max-width: 400px;
            text-align: center;
        }
        .modal-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }
        .modal-buttons button {
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .modal-buttons .confirm-button {
            background-color: var(--color-emphasis);
            color: white;
        }
        .modal-buttons .cancel-button {
            background-color: #ccc;
            color: #333;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <!-- Modal de Alerta Customizado (Colocado aqui para garantir que os elementos existam ao carregar o script) -->
    <div id="customAlertModal" class="modal">
        <div class="modal-content">
            <p id="customAlertMessage" class="text-xl mb-4"></p>
            <div class="modal-buttons">
                <button id="alertOkButton" class="cancel-button">OK</button>
            </div>
        </div>
    </div>

    <!-- Confirmação: NENHUM Mermaid JS e NENHUM SVG foram usados no código HTML ou JS. -->

    <header class="text-center mb-12 py-8 rounded-lg shadow-lg" style="background-color: var(--color-darker-bg); color: white;">
        <h1 class="text-4xl md:text-5xl font-bold mb-4">Análise de Gastos da Construção Residencial</h1>
        <p class="text-xl md:text-2xl opacity-90">Sua jornada para uma gestão de obras transparente e eficiente.</p>
        <div id="user-id-display" class="text-sm mt-2 opacity-75">Carregando ID do Usuário...</div>
    </header>

    <main class="max-w-6xl mx-auto">
        <section id="introduction" class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-3xl font-semibold mb-4 text-center" style="color: var(--color-emphasis);">Construindo Sonhos, Gerindo Custos</h2>
            <p class="text-lg text-gray-800 leading-relaxed">
                A construção de uma casa é um investimento significativo e uma jornada emocionante. Para garantir que seu projeto permaneça no caminho certo e dentro do orçamento, uma gestão financeira detalhada é crucial. Esta infografia interativa foi projetada para simplificar o acompanhamento dos seus gastos, oferecendo uma visão clara de onde cada Real está sendo investido. Entender a distribuição dos custos é o primeiro passo para tomar decisões informadas e otimizar cada etapa da sua obra.
            </p>
        </section>

        <section id="data-entry" class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-3xl font-semibold mb-6 text-center" style="color: var(--color-emphasis);">Registro de Gastos Detalhados</h2>
            <p class="text-lg text-gray-800 leading-relaxed mb-6">
                Insira seus gastos nas categorias apropriadas. Isso permitirá uma análise precisa e um controle financeiro eficaz.
            </p>

            <div class="flex flex-wrap justify-center gap-4 mb-8">
                <button class="tab-button px-6 py-3 rounded-lg font-bold text-lg shadow-md hover:bg-opacity-90 active" data-tab="mao-de-obra" style="background-color: var(--color-primary); color: white;">Mão de Obra</button>
                <button class="tab-button px-6 py-3 rounded-lg font-bold text-lg shadow-md hover:bg-opacity-90" data-tab="ferramentas" style="background-color: var(--color-secondary); color: var(--color-dark-text);">Ferramentas</button>
                <button class="tab-button px-6 py-3 rounded-lg font-bold text-lg shadow-md hover:bg-opacity-90" data-tab="material-obra" style="background-color: var(--color-secondary); color: var(--color-dark-text);">Material da Obra</button>
                <button class="tab-button px-6 py-3 rounded-lg font-bold text-lg shadow-md hover:bg-opacity-90" data-tab="gastos-indiretos" style="background-color: var(--color-secondary); color: var(--color-dark-text);">Gastos Indiretos</button>
            </div>

            <div id="tab-content-container">
                <div id="mao-de-obra" class="tab-content p-6 border border-gray-200 rounded-lg shadow-sm">
                    <h3 class="text-2xl font-bold mb-4" style="color: var(--color-primary);">Gastos com Mão de Obra</h3>
                    <form class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-1">
                            <label for="data-mao-de-obra" class="block text-gray-700 text-sm font-bold mb-2">Data do Pagamento:</label>
                            <input type="date" id="data-mao-de-obra" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <div class="col-span-1">
                            <label for="descricao-mao-de-obra" class="block text-gray-700 text-sm font-bold mb-2">Descrição:</label>
                            <input type="text" id="descricao-mao-de-obra" placeholder="Ex: Diária Pedreiro João" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <div class="col-span-1">
                            <label for="unidades-mao-de-obra" class="block text-gray-700 text-sm font-bold mb-2">Unidades:</label>
                            <input type="number" id="unidades-mao-de-obra" value="1" min="1" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div class="col-span-1">
                            <label for="valor-mao-de-obra" class="block text-gray-700 text-sm font-bold mb-2">Valor R$:</label>
                            <input type="number" id="valor-mao-de-obra" step="0.01" min="0" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <div class="col-span-1">
                            <label for="parcelas-mao-de-obra" class="block text-gray-700 text-sm font-bold mb-2">Parcelas:</label>
                            <input type="number" id="parcelas-mao-de-obra" value="1" min="1" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div class="col-span-1">
                            <label for="cartao-mao-de-obra" class="block text-gray-700 text-sm font-bold mb-2">Cartão/Forma de Pagamento:</label>
                            <select id="cartao-mao-de-obra" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                <option value="Dinheiro">Dinheiro</option>
                                <option value="PIX">PIX</option>
                                <option value="Débito">Débito</option>
                                <option value="Crédito (Meu)">Crédito (Meu)</option>
                                <option value="Crédito (Irmão)">Crédito (Irmão)</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>
                        <div class="col-span-full flex justify-end mt-4">
                            <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" style="background-color: var(--color-primary);">Adicionar Gasto</button>
                        </div>
                    </form>
                </div>

                <div id="ferramentas" class="tab-content p-6 border border-gray-200 rounded-lg shadow-sm hidden">
                    <h3 class="text-2xl font-bold mb-4" style="color: var(--color-primary);">Gastos com Ferramentas</h3>
                    <form class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-1">
                            <label for="data-ferramentas" class="block text-gray-700 text-sm font-bold mb-2">Data do Pagamento:</label>
                            <input type="date" id="data-ferramentas" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <div class="col-span-1">
                            <label for="descricao-ferramentas" class="block text-gray-700 text-sm font-bold mb-2">Descrição:</label>
                            <input type="text" id="descricao-ferramentas" placeholder="Ex: Aluguel Betoneira" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <div class="col-span-1">
                            <label for="unidades-ferramentas" class="block text-gray-700 text-sm font-bold mb-2">Unidades:</label>
                            <input type="number" id="unidades-ferramentas" value="1" min="1" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div class="col-span-1">
                            <label for="valor-ferramentas" class="block text-gray-700 text-sm font-bold mb-2">Valor R$:</label>
                            <input type="number" id="valor-ferramentas" step="0.01" min="0" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <div class="col-span-1">
                            <label for="parcelas-ferramentas" class="block text-gray-700 text-sm font-bold mb-2">Parcelas:</label>
                            <input type="number" id="parcelas-ferramentas" value="1" min="1" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div class="col-span-1">
                            <label for="cartao-ferramentas" class="block text-gray-700 text-sm font-bold mb-2">Cartão/Forma de Pagamento:</label>
                            <select id="cartao-ferramentas" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                <option value="Dinheiro">Dinheiro</option>
                                <option value="PIX">PIX</option>
                                <option value="Débito">Débito</option>
                                <option value="Crédito (Meu)">Crédito (Meu)</option>
                                <option value="Crédito (Irmão)">Crédito (Irmão)</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>
                        <div class="col-span-full flex justify-end mt-4">
                            <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" style="background-color: var(--color-primary);">Adicionar Gasto</button>
                        </div>
                    </form>
                </div>

                <div id="material-obra" class="tab-content p-6 border border-gray-200 rounded-lg shadow-sm hidden">
                    <h3 class="text-2xl font-bold mb-4" style="color: var(--color-primary);">Gastos com Material da Obra</h3>
                    <form class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-1">
                            <label for="data-material-obra" class="block text-gray-700 text-sm font-bold mb-2">Data do Pagamento:</label>
                            <input type="date" id="data-material-obra" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <div class="col-span-1">
                            <label for="descricao-material-obra" class="block text-gray-700 text-sm font-bold mb-2">Descrição:</label>
                            <input type="text" id="descricao-material-obra" placeholder="Ex: Cimento (5 sacos)" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <div class="col-span-1">
                            <label for="unidades-material-obra" class="block text-gray-700 text-sm font-bold mb-2">Unidades:</label>
                            <input type="number" id="unidades-material-obra" value="1" min="1" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div class="col-span-1">
                            <label for="valor-material-obra" class="block text-gray-700 text-sm font-bold mb-2">Valor R$:</label>
                            <input type="number" id="valor-material-obra" step="0.01" min="0" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <div class="col-span-1">
                            <label for="parcelas-material-obra" class="block text-gray-700 text-sm font-bold mb-2">Parcelas:</label>
                            <input type="number" id="parcelas-material-obra" value="1" min="1" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div class="col-span-1">
                            <label for="cartao-material-obra" class="block text-gray-700 text-sm font-bold mb-2">Cartão/Forma de Pagamento:</label>
                            <select id="cartao-material-obra" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                <option value="Dinheiro">Dinheiro</option>
                                <option value="PIX">PIX</option>
                                <option value="Débito">Débito</option>
                                <option value="Crédito (Meu)">Crédito (Meu)</option>
                                <option value="Crédito (Irmão)">Crédito (Irmão)</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>
                        <div class="col-span-full flex justify-end mt-4">
                            <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" style="background-color: var(--color-primary);">Adicionar Gasto</button>
                        </div>
                    </form>
                </div>

                <div id="gastos-indiretos" class="tab-content p-6 border border-gray-200 rounded-lg shadow-sm hidden">
                    <h3 class="text-2xl font-bold mb-4" style="color: var(--color-primary);">Gastos Indiretos</h3>
                    <form class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-1">
                            <label for="data-gastos-indiretos" class="block text-gray-700 text-sm font-bold mb-2">Data do Pagamento:</label>
                            <input type="date" id="data-gastos-indiretos" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <div class="col-span-1">
                            <label for="descricao-gastos-indiretos" class="block text-gray-700 text-sm font-bold mb-2">Descrição:</label>
                            <input type="text" id="descricao-gastos-indiretos" placeholder="Ex: Taxa Licenciamento" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <div class="col-span-1">
                            <label for="unidades-gastos-indiretos" class="block text-gray-700 text-sm font-bold mb-2">Unidades:</label>
                            <input type="number" id="unidades-gastos-indiretos" value="1" min="1" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div class="col-span-1">
                            <label for="valor-gastos-indiretos" class="block text-gray-700 text-sm font-bold mb-2">Valor R$:</label>
                            <input type="number" id="valor-gastos-indiretos" step="0.01" min="0" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <div class="col-span-1">
                            <label for="parcelas-gastos-indiretos" class="block text-gray-700 text-sm font-bold mb-2">Parcelas:</label>
                            <input type="number" id="parcelas-gastos-indiretos" value="1" min="1" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div class="col-span-1">
                            <label for="cartao-gastos-indiretos" class="block text-gray-700 text-sm font-bold mb-2">Cartão/Forma de Pagamento:</label>
                            <select id="cartao-gastos-indiretos" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                <option value="Dinheiro">Dinheiro</option>
                                <option value="PIX">PIX</option>
                                <option value="Débito">Débito</option>
                                <option value="Crédito (Meu)">Crédito (Meu)</option>
                                <option value="Crédito (Irmão)">Crédito (Irmão)</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>
                        <div class="col-span-full flex justify-end mt-4">
                            <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" style="background-color: var(--color-primary);">Adicionar Gasto</button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <section id="summary-visualization" class="bg-white rounded-lg shadow-md p-6 mb-8 grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
            <div class="md:col-span-1">
                <h2 class="text-3xl font-semibold mb-6" style="color: var(--color-emphasis);">Visão Geral dos Gastos</h2>
                <p class="text-lg text-gray-800 leading-relaxed mb-6">
                    Acompanhe o total gasto em cada categoria e a distribuição percentual para entender melhor a alocação de recursos em sua construção.
                </p>
                <div class="mb-6">
                    <h3 class="text-2xl font-bold mb-2" style="color: var(--color-dark-text);">Total Geral de Gastos:</h3>
                    <p id="total-geral" class="text-5xl font-extrabold" style="color: var(--color-primary);">R$ 0,00</p>
                </div>
                <div class="mb-4">
                    <h3 class="text-2xl font-bold mb-2" style="color: var(--color-dark-text);">Gastos por Categoria:</h3>
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="py-2 px-4 border-b text-left text-gray-700">Categoria</th>
                                <th class="py-2 px-4 border-b text-right text-gray-700">Valor Total</th>
                            </tr>
                        </thead>
                        <tbody id="summary-table-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
                 <div class="mt-8 mb-4">
                    <h3 class="text-2xl font-bold mb-2" style="color: var(--color-dark-text);">Previsão de Pagamentos Mensais por Cartão:</h3>
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="py-2 px-4 border-b text-left text-gray-700 whitespace-nowrap">Mês/Ano</th>
                                <th class="py-2 px-4 border-b text-right text-gray-700 whitespace-nowrap">Crédito (Meu)</th>
                                <th class="py-2 px-4 border-b text-right text-gray-700 whitespace-nowrap">Crédito (Irmão)</th>
                                <th class="py-2 px-4 border-b text-right text-gray-700 whitespace-nowrap">Outros Cartões</th>
                                <th class="py-2 px-4 border-b text-right text-gray-700 whitespace-nowrap">Total Mensal</th>
                            </tr>
                        </thead>
                        <tbody id="monthly-payments-table-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
                <div class="mt-8 flex justify-center">
                    <button id="clear-data-button" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" style="background-color: var(--color-emphasis);">Limpar Todos os Dados</button>
                </div>
            </div>
            <div class="md:col-span-1">
                <div class="chart-container">
                    <canvas id="expensesChart"></canvas>
                </div>
            </div>
        </section>

        <section id="detailed-expenses" class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-3xl font-semibold mb-6 text-center" style="color: var(--color-emphasis);">Detalhes dos Gastos por Categoria</h2>
            <p class="text-lg text-gray-800 leading-relaxed mb-6">
                Explore a lista completa de cada gasto, organizado por categoria, como uma planilha.
            </p>

            <div class="flex flex-wrap justify-center gap-4 mb-8">
                <button class="detailed-tab-button px-6 py-3 rounded-lg font-bold text-lg shadow-md hover:bg-opacity-90 active" data-tab="mao-de-obra" style="background-color: var(--color-primary); color: white;">Mão de Obra</button>
                <button class="detailed-tab-button px-6 py-3 rounded-lg font-bold text-lg shadow-md hover:bg-opacity-90" data-tab="ferramentas" style="background-color: var(--color-secondary); color: var(--color-dark-text);">Ferramentas</button>
                <button class="detailed-tab-button px-6 py-3 rounded-lg font-bold text-lg shadow-md hover:bg-opacity-90" data-tab="material-obra" style="background-color: var(--color-secondary); color: var(--color-dark-text);">Material da Obra</button>
                <button class="detailed-tab-button px-6 py-3 rounded-lg font-bold text-lg shadow-md hover:bg-opacity-90" data-tab="gastos-indiretos" style="background-color: var(--color-secondary); color: var(--color-dark-text);">Gastos Indiretos</button>
            </div>

            <div id="detailed-tab-content-container">
                <div id="detailed-mao-de-obra" class="detailed-tab-content p-6 border border-gray-200 rounded-lg shadow-sm overflow-x-auto">
                    <h3 class="text-2xl font-bold mb-4" style="color: var(--color-primary);">Lista de Gastos: Mão de Obra</h3>
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="py-2 px-4 border-b text-left text-gray-700 whitespace-nowrap">Data</th>
                                <th class="py-2 px-4 border-b text-left text-gray-700 whitespace-nowrap">Descrição</th>
                                <th class="py-2 px-4 border-b text-right text-gray-700 whitespace-nowrap">Unidades</th>
                                <th class="py-2 px-4 border-b text-right text-gray-700 whitespace-nowrap">Valor R$</th>
                                <th class="py-2 px-4 border-b text-right text-gray-700 whitespace-nowrap">Parcelas</th>
                                <th class="py-2 px-4 border-b text-left text-gray-700 whitespace-nowrap">Cartão</th>
                                <th class="py-2 px-4 border-b text-right text-gray-700 whitespace-nowrap">Valor Parcela</th>
                                <th class="py-2 px-4 border-b text-center text-gray-700">Pago?</th> <!-- Nova coluna para status de pagamento -->
                                <th class="py-2 px-4 border-b text-center text-gray-700">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="detailed-mao-de-obra-table-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>

                <div id="detailed-ferramentas" class="detailed-tab-content p-6 border border-gray-200 rounded-lg shadow-sm overflow-x-auto hidden">
                    <h3 class="text-2xl font-bold mb-4" style="color: var(--color-primary);">Lista de Gastos: Ferramentas</h3>
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="py-2 px-4 border-b text-left text-gray-700 whitespace-nowrap">Data</th>
                                <th class="py-2 px-4 border-b text-left text-gray-700 whitespace-nowrap">Descrição</th>
                                <th class="py-2 px-4 border-b text-right text-gray-700 whitespace-nowrap">Unidades</th>
                                <th class="py-2 px-4 border-b text-right text-gray-700 whitespace-nowrap">Valor R$</th>
                                <th class="py-2 px-4 border-b text-right text-gray-700 whitespace-nowrap">Parcelas</th>
                                <th class="py-2 px-4 border-b text-left text-gray-700 whitespace-nowrap">Cartão</th>
                                <th class="py-2 px-4 border-b text-right text-gray-700 whitespace-nowrap">Valor Parcela</th>
                                <th class="py-2 px-4 border-b text-center text-gray-700">Pago?</th> <!-- Nova coluna para status de pagamento -->
                                <th class="py-2 px-4 border-b text-center text-gray-700">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="detailed-ferramentas-table-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>

                <div id="detailed-material-obra" class="detailed-tab-content p-6 border border-gray-200 rounded-lg shadow-sm overflow-x-auto hidden">
                    <h3 class="text-2xl font-bold mb-4" style="color: var(--color-primary);">Lista de Gastos: Material da Obra</h3>
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="py-2 px-4 border-b text-left text-gray-700 whitespace-nowrap">Data</th>
                                <th class="py-2 px-4 border-b text-left text-gray-700 whitespace-nowrap">Descrição</th>
                                <th class="py-2 px-4 border-b text-right text-gray-700 whitespace-nowrap">Unidades</th>
                                <th class="py-2 px-4 border-b text-right text-gray-700 whitespace-nowrap">Valor R$</th>
                                <th class="py-2 px-4 border-b text-right text-gray-700 whitespace-nowrap">Parcelas</th>
                                <th class="py-2 px-4 border-b text-left text-gray-700 whitespace-nowrap">Cartão</th>
                                <th class="py-2 px-4 border-b text-right text-gray-700 whitespace-nowrap">Valor Parcela</th>
                                <th class="py-2 px-4 border-b text-center text-gray-700">Pago?</th> <!-- Nova coluna para status de pagamento -->
                                <th class="py-2 px-4 border-b text-center text-gray-700">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="detailed-material-obra-table-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>

                <div id="detailed-gastos-indiretos" class="detailed-tab-content p-6 border border-gray-200 rounded-lg shadow-sm overflow-x-auto hidden">
                    <h3 class="text-2xl font-bold mb-4" style="color: var(--color-primary);">Lista de Gastos: Gastos Indiretos</h3>
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="py-2 px-4 border-b text-left text-gray-700 whitespace-nowrap">Data</th>
                                <th class="py-2 px-4 border-b text-left text-gray-700 whitespace-nowrap">Descrição</th>
                                <th class="py-2 px-4 border-b text-right text-gray-700 whitespace-nowrap">Unidades</th>
                                <th class="py-2 px-4 border-b text-right text-gray-700 whitespace-nowrap">Valor R$</th>
                                <th class="py-2 px-4 border-b text-right text-gray-700 whitespace-nowrap">Parcelas</th>
                                <th class="py-2 px-4 border-b text-left text-gray-700 whitespace-nowrap">Cartão</th>
                                <th class="py-2 px-4 border-b text-right text-gray-700 whitespace-nowrap">Valor Parcela</th>
                                <th class="py-2 px-4 border-b text-center text-gray-700">Pago?</th> <!-- Nova coluna para status de pagamento -->
                                <th class="py-2 px-4 border-b text-center text-gray-700">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="detailed-gastos-indiretos-table-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="management-insights" class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-3xl font-semibold mb-4 text-center" style="color: var(--color-emphasis);">Insights de Gestão e Otimização</h2>
            <p class="text-lg text-gray-800 leading-relaxed mb-4">
                A tecnologia facilita o controle e a análise dos seus gastos. Ao registrar cada despesa, você ganha visibilidade total sobre o projeto, identifica onde o dinheiro está sendo mais investido e pode ajustar o planejamento conforme a necessidade.
            </p>
            <p class="text-lg text-gray-800 leading-relaxed">
                Gerenciar uma obra é um desafio, mas também uma oportunidade para otimizar recursos. Este tipo de controle permite antecipar problemas, negociar melhor com fornecedores e mão de obra, e, em última instância, garantir que sua casa seja construída de forma eficiente e sem surpresas financeiras desagradáveis.
            </p>
        </section>
    </main>

    <footer class="text-center mt-12 py-6 text-gray-600">
        <p>&copy; 2025 Infografia de Gastos da Construção. Todos os direitos reservados.</p>
    </footer>

    <!-- Modal de Confirmação para Limpar Dados -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <p class="text-xl mb-4">Tem certeza que deseja limpar TODOS os dados? Esta ação é irreversível e afetará todos os usuários.</p>
            <div class="modal-buttons">
                <button id="confirmClear" class="confirm-button">Sim, Limpar Tudo</button>
                <button id="cancelClear" class="cancel-button">Cancelar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Importações do Firestore: Adicionado 'doc' e 'updateDoc'
        import { getFirestore, addDoc, onSnapshot, collection, getDocs, deleteDoc, serverTimestamp, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ===========================================================================================
        // ATENÇÃO: VOCÊ PRECISA SUBSTITUIR ESTES VALORES COM A SUA CONFIGURAÇÃO DO FIREBASE
        // **IMPORTANTE**: Certifique-se de que o 'projectId' esteja preenchido e correto.
        // ===========================================================================================

        // COLE AQUI O OBJETO firebaseConfig QUE VOCÊ OBTERÁ DO SEU PROJETO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDELdHka4K6PvyRNRsH3gLcGpOGejKoAas",
            authDomain: "chacara-mogollon.firebaseapp.com",
            projectId: "chacara-mogollon", // <-- VERIFIQUE SE ESTE É EXATAMENTE O SEU PROJECT ID DO FIREBASE
            storageBucket: "chacara-mogollon.firebasestorage.app",
            messagingSenderId: "37237249124",
            appId: "1:37237249124:web:532839cbdf56ad14fa7b71"
        };

        // --- INÍCIO: LINHAS DE DEPURAGEM ---
        console.log("firebaseConfig carregada:", firebaseConfig);
        console.log("Valor de firebaseConfig.projectId:", firebaseConfig.projectId);
        console.log("Tipo de firebaseConfig.projectId:", typeof firebaseConfig.projectId);
        // --- FIM: LINHAS DE DEPURAGEM ---

        // Defina o appId (geralmente é o mesmo que o projectId na sua configuração do Firebase)
        const appId = firebaseConfig.projectId;

        // Não é necessário um token de autenticação inicial para login anônimo
        const initialAuthToken = null;

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // Dados da aplicação (serão populados e sincronizados com o Firestore)
        window.expenses = {
            'mao-de-obra': [],
            'ferramentas': [],
            'material-obra': [],
            'gastos-indiretos': []
        };

        // Mapeamento de categorias (agora global)
        window.categories = {
            'mao-de-obra': 'Mão de Obra',
            'ferramentas': 'Ferramentas',
            'material-obra': 'Material da Obra',
            'gastos-indiretos': 'Gastos Indiretos'
        };

        // Função para mostrar alertas personalizados (substitui alert()) - Definida antes de qualquer uso
        window.showCustomAlert = (message) => {
            const customAlertModal = document.getElementById('customAlertModal');
            const customAlertMessage = document.getElementById('customAlertMessage');
            const alertOkButton = document.getElementById('alertOkButton');

            if (!customAlertModal || !customAlertMessage || !alertOkButton) {
                console.error("Elementos do modal de alerta não encontrados. Não é possível exibir o alerta personalizado.");
                console.log("ALERTA: " + message); // Fallback para console.log
                return;
            }

            customAlertMessage.textContent = message;
            customAlertModal.style.display = 'flex';

            const closeAlert = () => {
                customAlertModal.style.display = 'none';
                alertOkButton.removeEventListener('click', closeAlert);
            };
            alertOkButton.addEventListener('click', closeAlert);
        };

        // Inicializa o Firebase
        if (!firebaseConfig.projectId || firebaseConfig.projectId === "SEU_PROJECT_ID_AQUI") {
            console.error("Erro: 'projectId' não fornecido ou é o placeholder na firebaseConfig. Por favor, preencha a configuração do Firebase.");
            window.showCustomAlert("Erro de Configuração: Por favor, insira o seu 'projectId' REAL e COMPLETO na seção `firebaseConfig` do código HTML para que o aplicativo possa se conectar ao Firebase.");
        } else {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase inicializado com sucesso.");
            } catch (error) {
                console.error("Erro ao inicializar Firebase. Verifique sua firebaseConfig:", error);
                window.showCustomAlert("Erro ao inicializar o Firebase. Verifique se a sua configuração está correta. Algumas funcionalidades podem não estar disponíveis.");
            }
        }

        // Autentica o usuário e configura o listener do Firestore
        if (auth && db) {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id-display').textContent = `ID do Usuário: ${userId}`;
                    isAuthReady = true;
                    console.log("Usuário autenticado:", userId);
                    setupFirestoreListener();
                } else {
                    console.log("Nenhum usuário autenticado, tentando login anônimo...");
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                            console.log("Login com token customizado bem-sucedido.");
                        } else {
                            await signInAnonymously(auth);
                            console.log("Login anônimo bem-sucedido.");
                        }
                    } catch (error) {
                        console.error("Erro ao fazer login:", error);
                        window.showCustomAlert("Erro ao fazer login. Você não poderá salvar/sincronizar dados.");
                    }
                }
            });
        } else {
             console.warn("Firebase Auth ou Database não estão disponíveis. Autenticação será ignorada.");
             window.showCustomAlert("Não foi possível carregar os serviços do Firebase (Autenticação ou Banco de Dados). Funcionalidades de sincronização podem não estar disponíveis.");
        }

        // Coleção Firestore para armazenar gastos
        const expensesCollectionPath = (appId && firebaseConfig.projectId && firebaseConfig.projectId !== "SEU_PROJECT_ID_AQUI") ? `artifacts/${appId}/public/data/expenses` : null;

        // Função para configurar o listener em tempo real do Firestore
        function setupFirestoreListener() {
            if (!isAuthReady || !db || !expensesCollectionPath) {
                console.warn("Firestore listener não pode ser configurado: Autenticação/DB/Caminho não prontos. Verifique sua configuração do Firebase.");
                window.showCustomAlert("O sistema de sincronização não pode ser iniciado. Por favor, verifique a configuração do seu projeto Firebase.");
                return;
            }

            const q = collection(db, expensesCollectionPath);

            onSnapshot(q, (snapshot) => {
                const newExpenses = {
                    'mao-de-obra': [],
                    'ferramentas': [],
                    'material-obra': [],
                    'gastos-indiretos': []
                };
                snapshot.forEach(docItem => { // Renomeado 'doc' para 'docItem' para evitar conflitos
                    const data = docItem.data();
                    if (data.category && newExpenses[data.category]) {
                        newExpenses[data.category].push({ id: docItem.id, ...data });
                    }
                });
                window.expenses = newExpenses;
                console.log("Dados do Firestore atualizados:", window.expenses);
                window.updateSummary();
            }, (error) => {
                console.error("Erro ao ouvir o Firestore:", error);
                window.showCustomAlert("Erro ao carregar dados do Firestore. As atualizações podem não ser em tempo real.");
            });
        }

        // Função para atualizar o status 'pago' de um gasto no Firestore
        window.updatePaidStatus = async (expenseId, isPaid) => {
            if (!isAuthReady || !db || !expensesCollectionPath) {
                window.showCustomAlert("Não é possível atualizar o status de pagamento: autenticação/DB/caminho não prontos.");
                return;
            }
            try {
                // A função 'doc' é utilizada para criar uma referência a um documento específico
                const expenseRef = doc(db, expensesCollectionPath, expenseId);
                // A função 'updateDoc' é utilizada para atualizar campos de um documento existente
                await updateDoc(expenseRef, {
                    isPaid: isPaid
                });
                console.log(`Status de pagamento do gasto ${expenseId} atualizado para ${isPaid}.`);
            } catch (error) {
                console.error("Erro ao atualizar status de pagamento:", error);
                window.showCustomAlert("Erro ao atualizar status de pagamento. Tente novamente.");
            }
        };

        // Funções auxiliares tornadas globais
        window.formatCurrency = (value) => new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(value);

        window.wrapLabel = (label) => {
            if (label.length <= 16) {
                return label;
            }
            const words = label.split(' ');
            const lines = [];
            let currentLine = '';
            words.forEach(word => {
                if ((currentLine + word).length <= 16) {
                    currentLine += (currentLine === '' ? '' : ' ') + word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            });
            lines.push(currentLine);
            return lines;
        };

        let expensesChart;
        let activeDetailedTab = 'mao-de-obra';

        function calculateMonthlyForecast() {
            const forecast = {};
            const today = new Date();
            const currentMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);

            Object.values(window.expenses).flat().forEach(item => {
                if (item.parcelas > 1 && (item.cartao === 'Crédito (Meu)' || item.cartao === 'Crédito (Irmão)' || item.cartao === 'Outro')) {
                    const startDate = new Date(item.data);
                    const monthlyAmount = item.valor / item.parcelas;

                    for (let i = 0; i < item.parcelas; i++) {
                        const paymentDate = new Date(startDate.getFullYear(), startDate.getMonth() + i, 1);

                        if (paymentDate < currentMonthStart) {
                            continue;
                        }

                        const monthYearKey = paymentDate.toLocaleString('pt-BR', { month: 'short', year: 'numeric' });

                        if (!forecast[monthYearKey]) {
                            forecast[monthYearKey] = {
                                'Crédito (Meu)': 0,
                                'Crédito (Irmão)': 0,
                                'Outros Cartões': 0,
                                'Total Mensal': 0,
                                'dateOrder': paymentDate.getTime()
                            };
                        }

                        if (item.cartao === 'Crédito (Meu)') {
                            forecast[monthYearKey]['Crédito (Meu)'] += monthlyAmount;
                        } else if (item.cartao === 'Crédito (Irmão)') {
                            forecast[monthYearKey]['Crédito (Irmão)'] += monthlyAmount;
                        } else if (item.cartao === 'Outro') {
                            forecast[monthYearKey]['Outros Cartões'] += monthlyAmount;
                        }
                        forecast[monthYearKey]['Total Mensal'] += monthlyAmount;
                    }
                }
            });

            const sortedForecast = Object.keys(forecast).map(key => ({
                monthYearKey: key,
                ...forecast[key]
            })).sort((a, b) => a.dateOrder - b.dateOrder);

            return sortedForecast;
        }

        function renderMonthlyForecast() {
            const monthlyPaymentsTableBody = document.getElementById('monthly-payments-table-body');
            monthlyPaymentsTableBody.innerHTML = '';

            const forecastData = calculateMonthlyForecast();

            if (forecastData.length === 0) {
                const row = monthlyPaymentsTableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 5;
                cell.textContent = 'Nenhuma previsão de pagamentos parcelados nos próximos meses.';
                cell.classList.add('text-center', 'py-4', 'text-gray-500');
                return;
            }

            forecastData.forEach(monthData => {
                const row = monthlyPaymentsTableBody.insertRow();
                row.insertCell().textContent = monthData.monthYearKey;
                row.cells[0].classList.add('whitespace-nowrap');
                row.insertCell().textContent = window.formatCurrency(monthData['Crédito (Meu)']);
                row.cells[1].classList.add('text-right');
                row.insertCell().textContent = window.formatCurrency(monthData['Crédito (Irmão)']);
                row.cells[2].classList.add('text-right');
                row.insertCell().textContent = window.formatCurrency(monthData['Outros Cartões']);
                row.cells[3].classList.add('text-right');
                row.insertCell().textContent = window.formatCurrency(monthData['Total Mensal']);
                row.cells[4].classList.add('text-right', 'font-bold');
            });
        }

        window.updateSummary = () => {
            const summaryTableBody = document.getElementById('summary-table-body');
            summaryTableBody.innerHTML = '';
            let totalGeneral = 0;
            const chartLabels = [];
            const chartData = [];
            const chartColors = [
                '#FF5733',
                '#FFC300',
                '#C70039',
                '#900C3F'
            ];

            const rootStyles = getComputedStyle(document.documentElement);
            const darkTextColor = rootStyles.getPropertyValue('--color-dark-text').trim();

            Object.keys(window.expenses).forEach((categoryKey) => {
                const totalCategory = window.expenses[categoryKey].reduce((sum, item) => sum + item.valor, 0);
                totalGeneral += totalCategory;

                const row = summaryTableBody.insertRow();
                row.insertCell().textContent = window.categories[categoryKey];
                row.insertCell().textContent = window.formatCurrency(totalCategory);
                row.cells[1].classList.add('text-right');

                if (totalCategory > 0) {
                    chartLabels.push(window.wrapLabel(window.categories[categoryKey]));
                    chartData.push(totalCategory);
                }
            });

            document.getElementById('total-geral').textContent = window.formatCurrency(totalGeneral);

            if (expensesChart) {
                expensesChart.data.labels = chartLabels;
                expensesChart.data.datasets[0].data = chartData;
                expensesChart.update();
            } else {
                const ctx = document.getElementById('expensesChart').getContext('2d');
                expensesChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            data: chartData,
                            backgroundColor: chartColors,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: {
                                        size: 14
                                    },
                                    color: darkTextColor,
                                    boxWidth: 20,
                                    padding: 20
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(tooltipItems) {
                                        const item = tooltipItems[0];
                                        let label = item.chart.data.labels[item.dataIndex];
                                        if (Array.isArray(label)) {
                                            return label.join(' ');
                                        } else {
                                            return label;
                                        }
                                    },
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (Array.isArray(label)) {
                                            label = label.join(' ');
                                        }
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += window.formatCurrency(context.parsed);
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            renderDetailedExpenses(activeDetailedTab);
            renderMonthlyForecast();
        };

        function renderDetailedExpenses(categoryKey) {
            const tableBodyId = `detailed-${categoryKey}-table-body`;
            const tableBody = document.getElementById(tableBodyId);
            if (!tableBody) {
                console.error(`Corpo da tabela não encontrado para a categoria: ${categoryKey}`);
                return;
            }
            tableBody.innerHTML = '';

            const categoryExpenses = window.expenses[categoryKey] || [];
            if (categoryExpenses.length === 0) {
                const row = tableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 9; // Aumentado para incluir a nova coluna 'Pago?'
                cell.textContent = 'Nenhum gasto registrado nesta categoria.';
                cell.classList.add('text-center', 'py-4', 'text-gray-500');
            } else {
                categoryExpenses.forEach(item => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = item.data;
                    row.insertCell().textContent = item.descricao;
                    row.insertCell().textContent = item.unidades;
                    row.cells[2].classList.add('text-right');
                    row.insertCell().textContent = window.formatCurrency(item.valor);
                    row.cells[3].classList.add('text-right');
                    row.insertCell().textContent = item.parcelas;
                    row.cells[4].classList.add('text-right');
                    row.insertCell().textContent = item.cartao;
                    row.insertCell().textContent = window.formatCurrency(item.valorParcela);
                    row.cells[6].classList.add('text-right');

                    // Coluna 'Pago?' com checkbox
                    const paidCell = row.insertCell();
                    const paidCheckbox = document.createElement('input');
                    paidCheckbox.type = 'checkbox';
                    paidCheckbox.checked = item.isPaid || false; // Define o estado do checkbox
                    paidCheckbox.classList.add('form-checkbox', 'h-5', 'w-5', 'text-blue-600');
                    // Adiciona um listener para atualizar o status no Firestore
                    paidCheckbox.onchange = (event) => {
                        window.updatePaidStatus(item.id, event.target.checked);
                    };
                    paidCell.appendChild(paidCheckbox);
                    paidCell.classList.add('text-center');

                    const actionsCell = row.insertCell();
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Remover';
                    deleteButton.classList.add('bg-red-400', 'hover:bg-red-600', 'text-white', 'px-3', 'py-1', 'rounded');
                    deleteButton.onclick = async () => {
                        if (!isAuthReady || !db || !expensesCollectionPath) {
                             window.showCustomAlert("Não é possível remover: autenticação/DB/caminho não prontos.");
                             return;
                        }
                        const confirmDelete = window.confirm("Tem certeza que deseja remover este gasto?");
                        if (confirmDelete) {
                            try {
                                await deleteDoc(doc(db, expensesCollectionPath, item.id));
                                console.log("Documento removido com sucesso:", item.id);
                            }                             catch (error) {
                                console.error("Erro ao remover documento:", error);
                                window.showCustomAlert("Erro ao remover gasto. Tente novamente.");
                            }
                        }
                    };
                    actionsCell.appendChild(deleteButton);
                    actionsCell.classList.add('text-center');
                });
            }
        }

        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.add('hidden'));

                button.classList.add('active');
                document.getElementById(button.dataset.tab).classList.remove('hidden');
            });
        });

        const detailedTabButtons = document.querySelectorAll('.detailed-tab-button');
        const detailedTabContents = document.querySelectorAll('.detailed-tab-content');

        detailedTabButtons.forEach(button => {
            button.addEventListener('click', () => {
                detailedTabButtons.forEach(btn => btn.classList.remove('active'));
                detailedTabContents.forEach(content => content.classList.add('hidden'));

                button.classList.add('active');
                const targetTabId = `detailed-${button.dataset.tab}`;
                document.getElementById(targetTabId).classList.remove('hidden');
                activeDetailedTab = button.dataset.tab;
                renderDetailedExpenses(activeDetailedTab);
            });
        });

        Object.keys(window.categories).forEach(categoryKey => {
            const form = document.querySelector(`#${categoryKey} form`);
            form.addEventListener('submit', async (event) => {
                event.preventDefault();

                if (!isAuthReady || !db || !expensesCollectionPath) {
                    window.showCustomAlert("Não é possível adicionar gasto: autenticação/DB/caminho não prontos. Tente novamente.");
                    return;
                }

                const data = form.querySelector(`#data-${categoryKey}`).value;
                const descricao = form.querySelector(`#descricao-${categoryKey}`).value;
                const unidades = parseInt(form.querySelector(`#unidades-${categoryKey}`).value);
                const valor = parseFloat(form.querySelector(`#valor-${categoryKey}`).value);
                const parcelas = parseInt(form.querySelector(`#parcelas-${categoryKey}`).value);
                const cartao = form.querySelector(`#cartao-${categoryKey}`).value;

                if (!data || !descricao || isNaN(valor) || valor <= 0) {
                    window.showCustomAlert('Por favor, preencha todos os campos obrigatórios (Data, Descrição, Valor R$).');
                    return;
                }

                const valorParcela = parcelas > 1 ? valor / parcelas : valor;

                const newExpense = {
                    category: categoryKey,
                    data,
                    descricao,
                    unidades,
                    valor,
                    parcelas,
                    cartao,
                    valorParcela,
                    isPaid: false, // Adicionado novo campo isPaid com valor padrão false
                    timestamp: serverTimestamp()
                };

                try {
                    await addDoc(collection(db, expensesCollectionPath), newExpense);
                    console.log("Gasto adicionado ao Firestore:", newExpense);
                    form.reset();
                    form.querySelector(`#unidades-${categoryKey}`).value = 1;
                    form.querySelector(`#parcelas-${categoryKey}`).value = 1;
                } catch (error) {
                    console.error("Erro ao adicionar gasto ao Firestore:", error);
                    window.showCustomAlert("Erro ao adicionar gasto. Tente novamente.");
                }
            });
        });

        const clearDataButton = document.getElementById('clear-data-button');
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmClearButton = document.getElementById('confirmClear');
        const cancelClearButton = document.getElementById('cancelClear');

        if (clearDataButton) {
            clearDataButton.addEventListener('click', () => {
                if (confirmationModal) {
                    confirmationModal.style.display = 'flex';
                }
            });
        }

        if (confirmClearButton) {
            confirmClearButton.addEventListener('click', async () => {
                if (!isAuthReady || !db || !expensesCollectionPath) {
                    window.showCustomAlert("Não é possível limpar dados: autenticação/DB/caminho não prontos.");
                    if (confirmationModal) {
                        confirmationModal.style.display = 'none';
                    }
                    return;
                }

                try {
                    const q = collection(db, expensesCollectionPath);
                    const querySnapshot = await getDocs(q);
                    const deletePromises = [];
                    querySnapshot.forEach((docItem) => {
                        deletePromises.push(deleteDoc(doc(db, expensesCollectionPath, docItem.id)));
                    });
                    await Promise.all(deletePromises);
                    console.log("Todos os documentos removidos do Firestore.");
                    if (confirmationModal) {
                        confirmationModal.style.display = 'none';
                    }
                } catch (error) {
                    console.error("Erro ao limpar dados do Firestore:", error);
                    window.showCustomAlert("Erro ao limpar dados. Tente novamente.");
                    if (confirmationModal) {
                        confirmationModal.style.display = 'none';
                    }
                }
            });
        }

        if (cancelClearButton) {
            cancelClearButton.addEventListener('click', () => {
                if (confirmationModal) {
                    confirmationModal.style.display = 'none';
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const initialDetailedTabButton = document.querySelector('.detailed-tab-button.active');
            if (initialDetailedTabButton) {
                const targetTabId = `detailed-${initialDetailedTabButton.dataset.tab}`;
                document.getElementById(targetTabId).classList.remove('hidden');
                activeDetailedTab = initialDetailedTabButton.dataset.tab;
                renderDetailedExpenses(activeDetailedTab);
            }
        });
    </script>
</body>
</html>
